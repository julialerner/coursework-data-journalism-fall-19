---
title: "Data Analysis Big Questions"
author: "Julia Lerner"
date: "11/03/2019"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


```{r}
# installing and loading packages that i might need
#install.packages("tidycensus")
#install.packages("rgdal")
#install.packages("rgdal")
#install.packages("tidyverse")
#install.packages("arcos")
#install.packages("scales")
#install.packages("ggrepel")
install.packages("mapview")
install.packages("ggthemes")
library(tidyverse)
library(janitor)
library(arcos)
library(scales)
library(ggrepel)
library(tidycensus)
library(mapview)
library(ggthemes)

```

```{r}
# store one of our API keys as an object called key
key <- "uO4EK6I"

arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
  clean_names()

arcos_buyer_yearly <- combined_buyer_annual(key=key) %>%
  clean_names()


```

```{r}
# load data fr buyer address, buyer totals, buyer annual by year, and state population per year
buyer_address <- read_csv("data/buyer_addresses.csv")
buyer_annual_by_year <- read_csv("data/buyer_annual_by_year.csv")
buyer_totals <- read_csv("data/buyer_totals.csv")
state_population_per_year <- read_csv("data/state_population_per_year.csv")
babies_per <- read_csv("data/delivery_hospitalizations.csv")
children_in_foster_care <- read_csv("data/children_in_foster_care.csv")
```


```{r}
# motivating questions!
# How many children (especially in states with high-opioid addiction rates) have gone into foster care in the years 2006-2012? 
# What is the rate of children taken from homes due to opioid addiction? 
# How many children are born addicted to opiates? 
# do states with higher rates of pills per person have higher foster care costs?
# what does it cost to help a baby get clean from opiates?
# how many children are in the foster care system nationally? per state?
# do states with higher rates of opioid use have higher rates of children in state care? 
# what percent of each state is actually housed in state care/foster system? 
# how has the rate of children in foster care in each state changed between 2006-2012?
# what percent of the US population lives in foster care/state care?
# Of the children seized from their parents, what percent was due to drug abuse? specifically opioids?
# if there are more overdose deaths in a state, are rates of children in fostercare higher?
# does the rate of babies born addicted rise with the number of pills sent to each state?
# why is vermont's rate of children born addicted so high, since it's not in the rust belt?

```

```{r}
# How many children (especially in states with high-opioid addiction rates) have gone into foster care in the years 2006-2012? 
# this is for nationwide, how many childen are in foster care for 2006-2012. 
children_in_foster <- children_in_foster_care %>%
  filter(TimeFrame %in% c("2006", "2007", "2008", "2009", "2010", "2011", "2012") & Location=="United States")

# now lets focus in on a particular state. According to the National Inpatient Sample and State Inpatient Database, Healthcare Cost and Utilization Project info, Vermont has the highest rate of change in babies per 1000 born addicted to opioids. Let's start there. 
```

```{r}
#How many children are in Vermont's foster system in the years 2006-2012?
children_in_VTfoster_2006 <- children_in_foster_care %>%
  filter(TimeFrame %in% c("2006", "2007", "2008", "2009", "2010", "2011", "2012") & Location=="Vermont") %>%
  rename(year = TimeFrame) %>%
  rename(total_kids = Data)
```

```{r}
# and how many pills were sent to vermont in this time frame? 
buyer_annual_year_VT <- buyer_annual_by_year %>%
  rename(State = buyer_state) %>%
  filter(State =="VT") %>%
  mutate(State = "Vermont") %>%
  group_by(year, State) %>%
  summarise(shipments = n(),
            total_pills = sum(dosage_unit)) 
```

```{r}
state_population_per_year_UPDATE <- state_population_per_year# %>%
 # rename(state = buyer_state)
```

```{r}

# the highest number of pills by year ws in 2009. was that also the year with the highest number of children in the system? 

kids_and_pills <- buyer_annual_year_VT %>%
  inner_join(children_in_VTfoster_2006, by="year") %>%
  select(year, total_pills, Location, total_kids) %>%
  arrange(desc(year)) %>%
  rename(state = Location)

kids_and_pills_and_pop <- kids_and_pills %>%
  full_join(state_population_per_year_UPDATE, by="state")

# interestingly the highest population of children in foster care was in 2006, when there were 1,379 kids in foster care. In 2009, when 20,783,165 pills flooded VT, there were only 1062 kids in foster care. 

```

```{r}
# okay but how percent of people in vermont were in foster care in this time frame?
# to do this I need to combine the data set of state population with the number of children in foster care. I need to get VT to equal Vermont, and then i need to create a new column that divides the foster number by the state total population per year. 

state_population_per_year_UPDATE <- state_population_per_year_UPDATE %>%
  rename(Location = state) %>%
  filter(Location=="VT") %>%
  mutate(Location="Vermont") 
 # mutate(VT=="Vermont")

kids_and_pop <- children_in_VTfoster_2006 %>%
  full_join(state_population_per_year_UPDATE, by ="Location") %>%
  filter(Location=="Vermont") %>%
  mutate(total_kids = as.numeric(total_kids)) %>%
  mutate(rate = (total_kids/population_average)*10000)

# now lets build a chart that visualizes this. 

ggplot(kids_and_pop) +
  geom_bar(stat="identity", aes(year, rate), fill="navy") +
  labs(x="year", y="rate of foster children per 10,000 in Vermont", title="In Vermont, the number of foster children per 10,000 in Vermont fell starting in 2006", subtitle = "After 2010, the number of foster children began to rise", caption = "Source: Census data") +
  scale_x_continuous(breaks = c(2006, 2007, 2008, 2009, 2010, 2011, 2012)) +
  scale_y_continuous(labels = comma)
```

```{r}
 # just ignore all of this it means absolutely nothing. okay cool thanks. 
# rate_of_VT <-state_population_per_year %>%
#  rename(Location = buyer_state) %>%
#  filter(str_detect(Location, "VT"))

#children_UPDATED<- children_in_foster_care %>%
#  rename(total = Data)

#children_UPDATED %>%
 # full_join(rate_of_VT) %>%
#  select(Location, total, TimeFrame, population_average) %>% 
#  filter(Location %in% c("Vermont", "VT"))

# i have been working for over an hour on trying to figure out how to get VT and Vermont to register as the same thing in this chart and i just can't figure it out so i am MOVING ON NOW. 

# VT_foster_care <- children_in_foster_care %>%
  #filter(Location =="Vermont") %>%
  #right_join(state_population_per_year, by="")

```

```{r}
# i want to find the rate of pills per person in vermont. to do this, i need to find the total pills per year, the population per year, and compare the two. 
```

```{r}
#how many pills went to vermont in 2006-2012? how many pills per person were sent to vermont in this time frame? 
buyer_annual_year_VT <- buyer_annual_year_VT %>%
  clean_names() %>%
  glimpse


state_population_per_year_UPDATE <- state_population_per_year_UPDATE%>%
  rename(state=Location) %>%
  glimpse


buyer_totals_vt <- buyer_annual_year_VT %>%
 inner_join(state_population_per_year_UPDATE, by="state") %>%
 group_by(state, population_average) %>%
 mutate(rate = total_pills/population_average) %>%
 arrange(desc(rate)) %>%
  filter(state =="Vermont")


# total number of pills: 123414703
# rate per person = 197.8865 TOTAL
#rate per year varies
 
# I'd like to make a chart showing the relationship between population and pills in the state. Let's make a bar graph of total population per year and then a line that shows the rate of pills per year 

ggplot(buyer_totals_vt) +
  geom_bar(stat="identity", aes(year, rate), fill="black") +
  labs(x="year", y="pills per person", title="In Vermont, the rate of pills per person peaked in 2009", subtitle = "In 2010, the number of pills per person began to fall", caption = "Source: Census data") +
  scale_x_continuous(breaks = c(2006, 2007, 2008, 2009, 2010, 2011, 2012)) +
  scale_y_continuous(labels = comma)

```

```{r}
 # okay it lowkey has taken me days to get to this point and i am so excited that I did would you LOOK at that MASTERPIECE of a graph up there !!!!!!!
```


```{r}
# this is the data to load the map below 
# Define API Key
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

# If you need to look up variables, this is how you do it
acs_variables <- load_variables(2017, "acs5" )

county_geodata <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE)

state_geodata <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE)

```


```{r}
# what's next? Let's look at children in foster care nationally
# let's make a sheet that just shows nuber of childrn in foster care, and then make one of those super cool US maps to show it off by year. 

# turn off scientific notation 
options(scipen=999)
# this is the sheet that the map will pull the data from. 
children_in_foster_care_STATES <- children_in_foster_care %>%
  filter(LocationType =="State") %>%
  rename(total_kids = Data) %>%
  rename(year=TimeFrame) %>%
  rename(state = Location) %>%
  mutate(total_kids=as.numeric(total_kids))

# do I combine this with the arcos map data? let's try loading that data separately

state_geodata <- get_acs(geography = "state",
    variables = "B01001_001", geometry = TRUE, shift_geo = TRUE) %>%
  rename(state = NAME) 

# now let's do a full join of foster care data and state shapes

state_foster_pops <- state_geodata %>% 
  full_join(children_in_foster_care_STATES, by="state") %>%
filter(year=="2006")
#select(state, variable, geometry, total_kids, year, estimate)

state_foster_pops %>%
  glimpse

# and this is the map 

#state_foster_pops %>%
 # ggplot(aes(fill = total_kids)) +
#  geom_sf()

state_foster_pops %>%
  ggplot(aes(fill = total_kids)) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='Population',title="California, Texas have largest populations", subtitle = "2017 population, U.S. Census", caption = "Source: U.S. Census ACS") +
  #scale_fill_continuous(labels = comma) +
  theme(legend.position="none")
# i can't figure this out. it just keeps telling me that "Error: stat_sf requires the following missing aesthetics: geometry" so let's just move on and I will ask sean on Monday. 

```
```{r}
# how many counties in the U.S. received more than 250,000 pills between 2006 and 2012? 

arcos_county_pills_per_year <- summarized_county_annual(key = key)

US_pharmacies_over250k <- arcos_county_pills_per_year %>%
  select(BUYER_STATE, BUYER_COUNTY, DOSAGE_UNIT, year) %>%
  arrange(desc(DOSAGE_UNIT)) %>%
  filter(DOSAGE_UNIT > 250000)

# there are 17,000 counties that received more than that. what if we filter by just vermont? 


vt_pharmacies_over250k <- arcos_county_pills_per_year %>%
  select(BUYER_STATE, BUYER_COUNTY, DOSAGE_UNIT, year) %>%
  arrange(desc(DOSAGE_UNIT)) %>%
  filter(DOSAGE_UNIT > 250000) %>%
  filter(BUYER_STATE=="VT")

# there are 17,000 counties that received more than 250K. what if we filter by a bigger number? 

US_pharmacies_over1m <- arcos_county_pills_per_year %>%
  select(BUYER_STATE, BUYER_COUNTY, DOSAGE_UNIT, year) %>%
  arrange(desc(DOSAGE_UNIT)) %>%
  filter(DOSAGE_UNIT > 1000000)

# wow there are still almost 11k options. I want to narrow it down by states that have the highest population of foster children. so let's do a glimpse of that data to decide which states to look at for the year 2006 (at the start of the crisis). 

children_in_foster_care_STATES %>%
  mutate(total_kids = as.numeric(total_kids)) %>%
  filter(year=="2006") %>%
  arrange(desc(total_kids))

# it looks like California, Texas, NY, Florida, Pennsylvania, Michigan, Illinois, and Ohio had the highest rates of children in foster care.  I want to look at California counties now to see if the rate of pills per foster kid is higher in california than in other states. 

US_pharmacies_CA <- arcos_county_pills_per_year %>%
  select(BUYER_STATE, BUYER_COUNTY, DOSAGE_UNIT, year) %>%
  arrange(desc(DOSAGE_UNIT)) %>%
  filter(BUYER_STATE=="CA", year=="2006")

```

```{r}
# lets find the rate of pills per foster kid in california in 2006.
foster_per_year_CA <- children_in_foster_care_STATES %>%
  filter(state=="California") %>%
   mutate(total_kids = as.numeric(total_kids)) %>%
  glimpse

buyer_yearly_CA <- arcos_buyer_yearly %>%
  filter(buyer_state=="CA") %>%
  mutate(buyer_state="California") %>%
  group_by(year, buyer_state) %>%
  summarise(shipments = n(),
            total_pills = sum(dosage_unit)) %>%
  rename(state=buyer_state) %>%
  glimpse

pills_foster_CA <- buyer_yearly_CA %>%
 inner_join(foster_per_year_CA, by="year") %>%
 #group_by(state, total_kids) %>%
 mutate(rate = total_pills/total_kids) %>%
 arrange(desc(rate)) 

# so in California in 2006, there were 11965.49 pills per foster kid. That seems really high! What does that same number look like in Vermont?

```

```{r}
foster_per_year_VT <- children_in_foster_care_STATES %>%
  filter(state=="Vermont") %>%
   mutate(total_kids = as.numeric(total_kids)) %>%
  glimpse

buyer_yearly_VT <- arcos_buyer_yearly %>%
  filter(buyer_state=="VT") %>%
  mutate(buyer_state="Vermont") %>%
  group_by(year, buyer_state) %>%
  summarise(shipments = n(),
            total_pills = sum(dosage_unit)) %>%
  rename(state=buyer_state) %>%
  glimpse

pills_foster_VT <- buyer_yearly_VT %>%
 inner_join(foster_per_year_VT, by="year") %>%
 #group_by(state, total_kids) %>%
 mutate(rate = total_pills/total_kids) %>%
 arrange(desc(rate)) 

# so in the same year, there were 10674.07 pills per foster kid sent to Vermont. These numbers are pretty similar, which is kind of shocking when you consider that there were only 1379 foster kids in Vermont in 2006, and 78373 foster kids in California in 2006. 

# We really seem to mostly be focusing on the rust belt for opioid data. I'm thinking someone should look at VT. ¯\_(ツ)_/¯
```


```{r}
# average pills per person by state
#average foster per person by state aka children_in_foster_care_STATES merged with state populations then mutate to add a column of rate 
# do a scatterplot of pills per person on one axis and foster per person on the other axis
#look at whether there is any kind of relationship there 
#statistical test 

#join pills_per_person with foster_rate_pop_VT
state_population_per_year <- state_population_per_year %>%
 rename(state=buyer_state)

#glimpse(state_population_per_year)
# buyer_annual_year_VT joined with state_population_per_year then mutate rate(pills per person)
pills_per_person <- state_population_per_year %>%
  full_join(buyer_annual_year_VT, by="state") %>%
  mutate(rate=total_pills/population_average) %>%
  filter(state=="Vermont") %>% glimpse
# set up state population per year
state_population_per_year <- state_population_per_year %>%
  #rename(state=buyer_state) %>%
  filter(state=="VT") %>%
  mutate(state="Vermont") 
#set up population for fosters per year. 
foster_rate_pop_VT <- children_in_foster_care_STATES %>%
  full_join(state_population_per_year, by="state") %>%
  filter(state=="Vermont") %>%
  mutate(rate=total_kids/population_average) %>%
  filter(year>="2006") %>%
  filter(year<="2012") %>% glimpse

# ok now that you have these two data sets, you need to do a scatterplot with them. first, inner join. then make the plot 

scatter_pills_kids <- pills_per_person %>%
  inner_join(foster_rate_pop_VT, by ="year")  %>%
  select(state.x, year, population_average.x, total_pills, total_kids, rate.x, rate.y) %>%
  rename(pills_per_person=rate.x) %>%
  rename(foster_per_person=rate.y)

```

```{r}
# here's the scatterplot for the foster rate and pills per person in VT
ggplot(scatter_pills_kids) +
  geom_point(aes(foster_per_person, pills_per_person)) +
  geom_smooth(aes(foster_per_person, pills_per_person), method = "lm", se = FALSE)  +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma)  +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text_repel(aes(foster_per_person, pills_per_person, label=foster_per_person),
                  subset(scatter_pills_kids)) +
  labs(x="fosters per person in VT", y="pills per person", title="as opioid use decreases, so do number of kids in foster care", caption = "Source: DEA ARCOS database, via Washington Post")
```

```{r}


#tell kimo we are trying to understand how programs that reunite homeless people with their families are happening 
#having specific info about where people are sent will help up
#do you provide this data to government agencies 
```









